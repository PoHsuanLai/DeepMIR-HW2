\documentclass{article}
\usepackage[utf8]{inputenc}
\usepackage{CJKutf8}
\usepackage{amsmath}
\usepackage{booktabs}
\usepackage{hyperref}
\usepackage{graphicx}

\title{HW2: Controllable Text-to-Music Generation}
\author{Student ID: R13921098}
\date{}

\begin{document}
\begin{CJK}{UTF8}{bsmi}

\maketitle

\section{Project Structure}

\begin{verbatim}
HW2/
|-- main_pipeline.py              # Main pipeline orchestration
|-- src/
|   |-- retrieval/
|   |   |-- audio_encoder.py      # Stable Audio VAE encoder
|   |   +-- similarity.py         # Cosine similarity retrieval
|   |-- captioning/
|   |   +-- audio_captioner.py    # LP-MusicCaps model
|   |-- extraction/
|   |   |-- melody_extractor.py   # Chromagram extraction
|   |   |-- rhythm_extractor.py   # Beat/onset detection
|   |   +-- dynamics_extractor.py # Dynamics features
|   |-- generation/
|   |   +-- music_generator.py    # MusicGen-Melody, JASCO
|   +-- evaluation/
|       |-- clap_similarity.py    # CLAP evaluation
|       |-- audiobox_aesthetics.py# Aesthetics metrics
|       +-- melody_accuracy.py    # Melody comparison (DTW)
|-- outputs/
|   |-- generated/                # Generated audio files
|   |   +-- jasco/               # JASCO outputs
|   |-- features/                 # Extracted features
|   |   |-- melody/
|   |   |-- rhythm/
|   |   +-- dynamics/
|   +-- results/                  # Evaluation results
+-- requirements.txt
\end{verbatim}

\section{Source Code}

Repository URL: https://github.com/PoHsuanLai/DeepMIR-HW2.git

\section{Generated Results}

Google Drive Link: https://drive.google.com/drive/folders/1YoL22fybbjkapoQFVY2ucqSCosW4TTES?usp=sharing

\section{Implementation Details}

\subsection{Model: JASCO (Best Configuration)}

\textbf{Model:} facebook/jasco-chords-drums-melody-1B (1B parameters)

\textbf{Text Input:} Qwen2-Audio-7B-Instruct (Qwen/Qwen2-Audio-7B-Instruct) generates natural language captions focusing on melodic character, rhythm, and harmonic progression without mentioning specific instruments.

\textbf{Time-Varying Conditions:}
\begin{itemize}
    \item \textbf{Melody:} JASCO melody salience matrix (53 MIDI note bins, 36-88) extracted using basic\_pitch with threshold 0.3 for sparse, salient pitch activations.
    \item \textbf{Chords:} Extracted from full mix via librosa chroma\_stft with template matching (24 chord types: major/minor). Format: (chord\_label, timestamp) tuples.
    \item \textbf{Drums:} Separated drum track via Demucs htdemucs model from full mix.
\end{itemize}

\textbf{Generation Parameters (Best from CFG Experiments):}
\begin{itemize}
    \item Duration: 10 seconds (fixed)
    \item Sample rate: 32kHz
    \item CFG coefficients: $\gamma_{\text{all}}=3.0$, $\gamma_{\text{txt}}=3.0$ (equal weighting)
    \item Configuration: text\_focused (best balance between target matching and text adherence)
\end{itemize}

\section{Aggregate Evaluation Results}

\textbf{Note:} Results shown are aggregate metrics from the best configuration (text\_focused: $\gamma_{\text{all}}=3.0$, $\gamma_{\text{txt}}=3.0$) across 9 diverse target files including Western classical (rock, jazz, country) and Chinese traditional music (bamboo flute, piano).

\subsection{Overall Performance}

\begin{itemize}
    \item \textbf{CLAP Gen$\leftrightarrow$Target:} 0.4292 (target audio similarity)
    \item \textbf{CLAP Text$\leftrightarrow$Gen:} 0.3035 (text adherence)
    \item \textbf{CLAP Text$\leftrightarrow$Target:} 0.2421 (caption quality baseline)
    \item \textbf{Melody Accuracy:} 0.3346 (pitch contour and chroma similarity)
    \item \textbf{Aesthetics CE:} 0.978 (content enjoyment)
    \item \textbf{Aesthetics PQ:} 1.000 (production quality)
\end{itemize}

\section{Sample Evaluation Results}

\subsection{6\_rock\_102\_beat\_3-4.wav}

\textbf{Generated File:} \texttt{6\_rock\_102\_beat\_3-4\_generated.wav}

\textbf{Text Input (Qwen2-Audio Natural Language Caption):}

\small
The music has a bouncy and lively feel with a melody that flows smoothly. It maintains a consistent rhythm and beat, moving along at a moderate tempo. There's a sense of brightness to the harmonic progression, giving it an uplifting quality. Overall, the music exudes energy and a vibrant atmosphere.
\normalsize

\textbf{CLAP Similarity:}
\begin{itemize}
    \item Target $\leftrightarrow$ Text: -0.0296
    \item Text $\leftrightarrow$ Generated: 0.1713
    \item Generated $\leftrightarrow$ Target: 0.6201
\end{itemize}

\textbf{Meta Audiobox Aesthetics:}
\begin{itemize}
    \item Target: CE=0.555, CU=0.902, PC=1.000, PQ=1.000
    \item Generated: CE=1.000, CU=1.000, PC=1.000, PQ=1.000
\end{itemize}

\textbf{Melody Accuracy:}
\begin{itemize}
    \item Chroma Similarity: 0.7000
    \item Chroma Accuracy: 0.2227
    \item Pitch Contour Similarity: 0.3877
    \item Overall: 0.4154
\end{itemize}

\subsection{10\_country\_114\_beat\_4-4.wav}

\textbf{Generated File:} \texttt{10\_country\_114\_beat\_4-4\_generated.wav}

\textbf{Text Input (Qwen2-Audio Natural Language Caption):}

\small
The melody is bouncy and lively, with a steady beat that gives it a groovy feel. It's not too high-pitched, making it easy to listen to. The harmony isn't too complex, but it contributes to an uplifting and fun atmosphere. Overall, the song has a cheerful mood and energy level that makes you want to move along with the beat.
\normalsize

\textbf{CLAP Similarity:}
\begin{itemize}
    \item Target $\leftrightarrow$ Text: -0.0641
    \item Text $\leftrightarrow$ Generated: 0.2157
    \item Generated $\leftrightarrow$ Target: 0.4463
\end{itemize}

\textbf{Meta Audiobox Aesthetics:}
\begin{itemize}
    \item Target: CE=0.562, CU=0.631, PC=1.000, PQ=1.000
    \item Generated: CE=0.803, CU=1.000, PC=1.000, PQ=1.000
\end{itemize}

\textbf{Melody Accuracy:}
\begin{itemize}
    \item Chroma Similarity: 0.6887
    \item Chroma Accuracy: 0.1021
    \item Pitch Contour Similarity: 0.5430
    \item Overall: 0.4103
\end{itemize}

\subsection{4\_jazz\_120\_beat\_3-4.wav}

\textbf{Generated File:} \texttt{4\_jazz\_120\_beat\_3-4\_generated.wav}

\textbf{Text Input (Qwen2-Audio Natural Language Caption):}

\small
The melody is bouncy and lively, with a steady beat that gives it a groovy feel. It's not too fast or too slow, creating an easy-going atmosphere. The harmony isn't complex but has a hint of darkness, adding depth to the sound. Overall, the music exudes a cheerful vibe that makes you want to move your feet.
\normalsize

\textbf{CLAP Similarity:}
\begin{itemize}
    \item Target $\leftrightarrow$ Text: 0.0004
    \item Text $\leftrightarrow$ Generated: 0.1706
    \item Generated $\leftrightarrow$ Target: 0.6446
\end{itemize}

\textbf{Meta Audiobox Aesthetics:}
\begin{itemize}
    \item Target: CE=0.693, CU=0.719, PC=1.000, PQ=1.000
    \item Generated: CE=1.000, CU=1.000, PC=1.000, PQ=1.000
\end{itemize}

\textbf{Melody Accuracy:}
\begin{itemize}
    \item Chroma Similarity: 0.6880
    \item Chroma Accuracy: 0.0209
    \item Pitch Contour Similarity: 0.3877
    \item Overall: 0.3310
\end{itemize}

\subsection{菊花台-周杰倫 (Bamboo flute)}

\textbf{Generated File:} \texttt{【菊花台-周杰倫（D調）】附伴奏⧸鋼琴伴奏\_generated.wav}

\textbf{Text Input (Qwen2-Audio Natural Language Caption):}

\small
The melody in this music piece flows smoothly and feels light, creating a relaxed and happy atmosphere. It moves at a moderate tempo with a steady rhythm and beat, providing a sense of calmness and peace. The harmonic progression tends to be major, contributing to an uplifting and cheerful vibe. Overall, the piece has a low energy level, making it suitable for moments of relaxation or introspection.
\normalsize

\textbf{CLAP Similarity:}
\begin{itemize}
    \item Target $\leftrightarrow$ Text: 0.3563
    \item Text $\leftrightarrow$ Generated: 0.2453
    \item Generated $\leftrightarrow$ Target: 0.2722
\end{itemize}

\textbf{Meta Audiobox Aesthetics:}
\begin{itemize}
    \item Target: CE=1.000, CU=0.919, PC=1.000, PQ=1.000
    \item Generated: CE=1.000, CU=1.000, PC=1.000, PQ=1.000
\end{itemize}

\textbf{Melody Accuracy:}
\begin{itemize}
    \item Chroma Similarity: 0.4391
    \item Chroma Accuracy: 0.1230
    \item Pitch Contour Similarity: 0.5525
    \item Overall: 0.3467
\end{itemize}

\subsection{Hedwig's theme x dizi (Harry Potter)}

\textbf{Generated File:} \texttt{Hedwig's theme x dizi\_60s\_generated.wav}

\textbf{Text Input (Qwen2-Audio Natural Language Caption):}

\small
The melody is bouncy and light, making it feel energetic. It has a moderate tempo with a steady beat, creating an uplifting yet calm atmosphere. The harmony follows a descending pattern which contributes to a slightly melancholic feeling. Overall, the music exudes warmth and positivity.
\normalsize

\textbf{CLAP Similarity:}
\begin{itemize}
    \item Target $\leftrightarrow$ Text: 0.3098
    \item Text $\leftrightarrow$ Generated: 0.3358
    \item Generated $\leftrightarrow$ Target: 0.4692
\end{itemize}

\textbf{Meta Audiobox Aesthetics:}
\begin{itemize}
    \item Target: CE=1.000, CU=1.000, PC=1.000, PQ=1.000
    \item Generated: CE=1.000, CU=0.698, PC=1.000, PQ=1.000
\end{itemize}

\textbf{Melody Accuracy:}
\begin{itemize}
    \item Chroma Similarity: 0.2391
    \item Chroma Accuracy: 0.0882
    \item Pitch Contour Similarity: 0.4751
    \item Overall: 0.2495
\end{itemize}

\subsection{竹笛｜这世界那么多人 (Cover)}

\textbf{Generated File:} \texttt{竹笛｜这世界那么多人\_cover\_60s\_generated.wav}

\textbf{Text Input (Qwen2-Audio Natural Language Caption):}

\small
The melody in this music piece flows smoothly, creating a gentle and calming sound. It's not too fast or too slow, providing a steady and soothing rhythm that invites relaxation. The harmony is丰富 yet balanced, contributing to an overall warm and inviting atmosphere. The energy level is low, making it suitable for moments of introspection or relaxation.
\normalsize

\textbf{CLAP Similarity:}
\begin{itemize}
    \item Target $\leftrightarrow$ Text: 0.5833
    \item Text $\leftrightarrow$ Generated: 0.4281
    \item Generated $\leftrightarrow$ Target: 0.5240
\end{itemize}

\textbf{Meta Audiobox Aesthetics:}
\begin{itemize}
    \item Target: CE=1.000, CU=0.938, PC=1.000, PQ=1.000
    \item Generated: CE=1.000, CU=1.000, PC=1.000, PQ=1.000
\end{itemize}

\textbf{Melody Accuracy:}
\begin{itemize}
    \item Chroma Similarity: 0.4122
    \item Chroma Accuracy: 0.1810
    \item Pitch Contour Similarity: 0.3814
    \item Overall: 0.3105
\end{itemize}

\subsection{Spirited Away OST (Piano)}

\textbf{Generated File:} \texttt{Spirited Away OST\_60s\_generated.wav}

\textbf{Text Input (Qwen2-Audio Natural Language Caption):}

\small
The melody of the piece flows smoothly, creating a gentle and calming sound. It's not too fast or too slow, providing a steady and relaxed pace throughout. The harmony is relatively major, contributing to an uplifting and positive atmosphere. The rhythm and beat remain consistent, maintaining a steady tempo that supports the smooth flow of the melody. Overall, the piece has a light and lively energy level, making it enjoyable and engaging to listen to.
\normalsize

\textbf{CLAP Similarity:}
\begin{itemize}
    \item Target $\leftrightarrow$ Text: 0.4485
    \item Text $\leftrightarrow$ Generated: 0.2213
    \item Generated $\leftrightarrow$ Target: 0.2958
\end{itemize}

\textbf{Meta Audiobox Aesthetics:}
\begin{itemize}
    \item Target: CE=1.000, CU=0.692, PC=1.000, PQ=1.000
    \item Generated: CE=1.000, CU=1.000, PC=1.000, PQ=1.000
\end{itemize}

\textbf{Melody Accuracy:}
\begin{itemize}
    \item Chroma Similarity: 0.3626
    \item Chroma Accuracy: 0.2065
    \item Pitch Contour Similarity: 0.5296
    \item Overall: 0.3503
\end{itemize}

\subsection{Mussorgsky: Pictures at an Exhibition (Piano)}

\textbf{Generated File:} \texttt{Mussorgsky\_60s\_generated.wav}

\textbf{Text Input (Qwen2-Audio Natural Language Caption):}

\small
The melody feels light and bouncy, moving smoothly from note to note without any sharp jolts. It has a moderate tempo, neither too fast nor too slow, creating an easy-going atmosphere. The harmony follows a typical classical pattern, moving through a sequence of major and minor chords that contribute to a slightly somber but still pleasant mood. Overall, the music has a relaxed and uplifting energy level.
\normalsize

\textbf{CLAP Similarity:}
\begin{itemize}
    \item Target $\leftrightarrow$ Text: 0.3392
    \item Text $\leftrightarrow$ Generated: 0.5476
    \item Generated $\leftrightarrow$ Target: 0.3595
\end{itemize}

\textbf{Meta Audiobox Aesthetics:}
\begin{itemize}
    \item Target: CE=1.000, CU=0.689, PC=1.000, PQ=1.000
    \item Generated: CE=1.000, CU=1.000, PC=1.000, PQ=1.000
\end{itemize}

\textbf{Melody Accuracy:}
\begin{itemize}
    \item Chroma Similarity: 0.3217
    \item Chroma Accuracy: 0.0789
    \item Pitch Contour Similarity: 0.6663
    \item Overall: 0.3280
\end{itemize}

\subsection{IRIS OUT (Piano)}

\textbf{Generated File:} \texttt{IRIS OUT\_generated.wav}

\textbf{Text Input (Qwen2-Audio Natural Language Caption):}

\small
The melody feels light and bouncy, with a sense of joy and ease. It's not too fast or too slow but moves at a comfortable pace. The harmony isn't complex but has a pleasant major key that contributes to an uplifting atmosphere. The rhythm maintains a steady tempo, giving the music a sense of stability and flow. Overall, it's a lively and energetic track that leaves you feeling uplifted and positive.
\normalsize

\textbf{CLAP Similarity:}
\begin{itemize}
    \item Target $\leftrightarrow$ Text: 0.2357
    \item Text $\leftrightarrow$ Generated: 0.3958
    \item Generated $\leftrightarrow$ Target: 0.2313
\end{itemize}

\textbf{Meta Audiobox Aesthetics:}
\begin{itemize}
    \item Target: CE=1.000, CU=1.000, PC=1.000, PQ=1.000
    \item Generated: CE=1.000, CU=1.000, PC=1.000, PQ=1.000
\end{itemize}

\textbf{Melody Accuracy:}
\begin{itemize}
    \item Chroma Similarity: 0.3891
    \item Chroma Accuracy: 0.0928
    \item Pitch Contour Similarity: 0.3852
    \item Overall: 0.2694
\end{itemize}

\section{CFG Experiments}

\subsection{JASCO Configuration Results}

\begin{table}[h]
\centering
\caption{JASCO CFG Configuration Results}
\label{tab:jasco_cfg}
\begin{tabular}{lcccccc}
\toprule
Config & $\gamma_{\text{all}}$ & $\gamma_{\text{txt}}$ & Gen$\leftrightarrow$Target & Text$\leftrightarrow$Gen & Melody Acc & Aesthetics CE \\
\midrule
text\_focused & 3.0 & 3.0 & 0.3800 & 0.3339 & 0.3318 & 0.915 \\
text\_heavy & 2.0 & 4.0 & 0.3751 & 0.3163 & 0.3423 & 0.949 \\
melody\_focused & 5.0 & 1.0 & 0.3666 & 0.2517 & 0.3349 & 0.942 \\
balanced & 4.0 & 2.0 & 0.3621 & 0.2316 & 0.3395 & 0.983 \\
melody\_heavy & 7.0 & 0.5 & 0.3218 & 0.2471 & 0.3445 & 0.979 \\
\bottomrule
\end{tabular}
\end{table}

\subsection{MusicGen-Melody Configuration Results}

\begin{table}[h]
\centering
\caption{MusicGen-Melody Guidance Scale Results}
\label{tab:musicgen_guidance}
\begin{tabular}{lccccc}
\toprule
Config & Guidance Scale & Gen$\leftrightarrow$Target & Text$\leftrightarrow$Gen & Melody Acc & Aesthetics CE \\
\midrule
guidance\_medium & 3.0 & 0.2146 & 0.2760 & 0.2674 & 1.000 \\
guidance\_low & 2.0 & 0.2063 & 0.2005 & 0.2625 & 1.000 \\
guidance\_high & 5.0 & 0.1803 & 0.3668 & 0.2637 & 1.000 \\
\bottomrule
\end{tabular}
\end{table}

\subsection{Model Comparison}

\begin{table}[h]
\centering
\caption{JASCO vs MusicGen-Melody (Best Configurations)}
\label{tab:model_comparison}
\begin{tabular}{lccccc}
\toprule
Model & Configuration & Gen$\leftrightarrow$Target & Text$\leftrightarrow$Gen & Melody Acc & Aesthetics CE \\
\midrule
JASCO & text\_focused (3.0/3.0) & 0.4292 & 0.3035 & 0.3346 & 0.978 \\
MusicGen-Melody & guidance\_medium (3.0) & 0.2146 & 0.2760 & 0.2674 & 1.000 \\
\bottomrule
\end{tabular}
\end{table}

\section{Thoughts}

\textbf{CFG Trade-off:} Equal weighting (3.0/3.0) achieves the best balance, heavy melody guidance (7.0/0.5) degrades target matching while heavy text guidance (2.0/4.0) maintains reasonable performance.

\textbf{JASCO vs MusicGen-Melody:} JASCO outperforms MusicGen-Melody by 100\% on Gen$\leftrightarrow$Target (0.43 vs 0.21), demonstrating that separate CFG controls for melody/chords/drums provide superior controllability over single guidance scale.

\textbf{LP-MusicCaps vs Qwen2-Audio:} Qwen2-Audio generates natural, controllable descriptions focusing on melodic character and rhythm, while LP-MusicCaps produces segment-based technical descriptions with repetitive patterns unsuitable for text-to-music models.

\end{CJK}
\end{document}

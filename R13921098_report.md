# HW2: Controllable Text-to-Music Generation

**Student ID:** R13921098

---

## Project Structure

```
HW2/
|-- main_pipeline.py              # Main pipeline orchestration
|-- src/
|   |-- retrieval/
|   |   |-- audio_encoder.py      # Stable Audio VAE encoder
|   |   +-- similarity.py         # Cosine similarity retrieval
|   |-- captioning/
|   |   +-- audio_captioner.py    # LP-MusicCaps model
|   |-- extraction/
|   |   |-- melody_extractor.py   # Chromagram extraction
|   |   |-- rhythm_extractor.py   # Beat/onset detection
|   |   +-- dynamics_extractor.py # Dynamics features
|   |-- generation/
|   |   +-- music_generator.py    # MusicGen-Melody, JASCO
|   +-- evaluation/
|       |-- clap_similarity.py    # CLAP evaluation
|       |-- audiobox_aesthetics.py# Aesthetics metrics
|       +-- melody_accuracy.py    # Melody comparison (DTW)
|-- outputs/
|   |-- generated/                # Generated audio files
|   |   +-- jasco/               # JASCO outputs
|   |-- features/                 # Extracted features
|   |   |-- melody/
|   |   |-- rhythm/
|   |   +-- dynamics/
|   +-- results/                  # Evaluation results
+-- requirements.txt
```

## Source Code

Repository URL: https://github.com/PoHsuanLai/DeepMIR-HW2.git

## Generated Results

Google Drive Link: https://drive.google.com/drive/folders/1YoL22fybbjkapoQFVY2ucqSCosW4TTES?usp=sharing

---

## Implementation Details

### Model: JASCO (Best Configuration)

**Model:** facebook/jasco-chords-drums-melody-1B (1B parameters)

**Text Input:** Qwen2-Audio-7B-Instruct (Qwen/Qwen2-Audio-7B-Instruct) generates natural language captions focusing on melodic character, rhythm, and harmonic progression without mentioning specific instruments.

**Time-Varying Conditions:**
- **Melody:** JASCO melody salience matrix (53 MIDI note bins, 36-88) extracted using basic_pitch with threshold 0.3 for sparse, salient pitch activations.
- **Chords:** Extracted from full mix via librosa chroma_stft with template matching (24 chord types: major/minor). Format: (chord_label, timestamp) tuples.
- **Drums:** Separated drum track via Demucs htdemucs model from full mix.

**Generation Parameters (Best from CFG Experiments):**
- Duration: 10 seconds (fixed)
- Sample rate: 32kHz
- CFG coefficients: γ_all=3.0, γ_txt=3.0 (equal weighting)
- Configuration: text_focused (best balance between target matching and text adherence)

---

## Aggregate Evaluation Results

**Note:** Results shown are aggregate metrics from the best configuration (text_focused: γ_all=3.0, γ_txt=3.0) across 9 diverse target files including Western classical (rock, jazz, country) and Chinese traditional music (bamboo flute, piano).

### Overall Performance

- **CLAP Gen↔Target:** 0.4292 (target audio similarity)
- **CLAP Text↔Gen:** 0.3035 (text adherence)
- **CLAP Text↔Target:** 0.2421 (caption quality baseline)
- **Melody Accuracy:** 0.3346 (pitch contour and chroma similarity)
- **Aesthetics CE:** 0.978 (content enjoyment)
- **Aesthetics PQ:** 1.000 (production quality)

---

## Sample Evaluation Results

### 6_rock_102_beat_3-4.wav

**Generated File:** `6_rock_102_beat_3-4_generated.wav`

**Text Input (Qwen2-Audio Natural Language Caption):**

The music has a bouncy and lively feel with a melody that flows smoothly. It maintains a consistent rhythm and beat, moving along at a moderate tempo. There's a sense of brightness to the harmonic progression, giving it an uplifting quality. Overall, the music exudes energy and a vibrant atmosphere.

**CLAP Similarity:**
- Target ↔ Text: -0.0296
- Text ↔ Generated: 0.1713
- Generated ↔ Target: 0.6201

**Meta Audiobox Aesthetics:**
- Target: CE=0.555, CU=0.902, PC=1.000, PQ=1.000
- Generated: CE=1.000, CU=1.000, PC=1.000, PQ=1.000

**Melody Accuracy:**
- Chroma Similarity: 0.7000
- Chroma Accuracy: 0.2227
- Pitch Contour Similarity: 0.3877
- Overall: 0.4154

---

### 10_country_114_beat_4-4.wav

**Generated File:** `10_country_114_beat_4-4_generated.wav`

**Text Input (Qwen2-Audio Natural Language Caption):**

The melody is bouncy and lively, with a steady beat that gives it a groovy feel. It's not too high-pitched, making it easy to listen to. The harmony isn't too complex, but it contributes to an uplifting and fun atmosphere. Overall, the song has a cheerful mood and energy level that makes you want to move along with the beat.

**CLAP Similarity:**
- Target ↔ Text: -0.0641
- Text ↔ Generated: 0.2157
- Generated ↔ Target: 0.4463

**Meta Audiobox Aesthetics:**
- Target: CE=0.562, CU=0.631, PC=1.000, PQ=1.000
- Generated: CE=0.803, CU=1.000, PC=1.000, PQ=1.000

**Melody Accuracy:**
- Chroma Similarity: 0.6887
- Chroma Accuracy: 0.1021
- Pitch Contour Similarity: 0.5430
- Overall: 0.4103

---

### 4_jazz_120_beat_3-4.wav

**Generated File:** `4_jazz_120_beat_3-4_generated.wav`

**Text Input (Qwen2-Audio Natural Language Caption):**

The melody is bouncy and lively, with a steady beat that gives it a groovy feel. It's not too fast or too slow, creating an easy-going atmosphere. The harmony isn't complex but has a hint of darkness, adding depth to the sound. Overall, the music exudes a cheerful vibe that makes you want to move your feet.

**CLAP Similarity:**
- Target ↔ Text: 0.0004
- Text ↔ Generated: 0.1706
- Generated ↔ Target: 0.6446

**Meta Audiobox Aesthetics:**
- Target: CE=0.693, CU=0.719, PC=1.000, PQ=1.000
- Generated: CE=1.000, CU=1.000, PC=1.000, PQ=1.000

**Melody Accuracy:**
- Chroma Similarity: 0.6880
- Chroma Accuracy: 0.0209
- Pitch Contour Similarity: 0.3877
- Overall: 0.3310

---

### 菊花台-周杰倫 (Bamboo flute)

**Generated File:** `【菊花台-周杰倫（D調）】附伴奏⧸鋼琴伴奏_generated.wav`

**Text Input (Qwen2-Audio Natural Language Caption):**

The melody in this music piece flows smoothly and feels light, creating a relaxed and happy atmosphere. It moves at a moderate tempo with a steady rhythm and beat, providing a sense of calmness and peace. The harmonic progression tends to be major, contributing to an uplifting and cheerful vibe. Overall, the piece has a low energy level, making it suitable for moments of relaxation or introspection.

**CLAP Similarity:**
- Target ↔ Text: 0.3563
- Text ↔ Generated: 0.2453
- Generated ↔ Target: 0.2722

**Meta Audiobox Aesthetics:**
- Target: CE=1.000, CU=0.919, PC=1.000, PQ=1.000
- Generated: CE=1.000, CU=1.000, PC=1.000, PQ=1.000

**Melody Accuracy:**
- Chroma Similarity: 0.4391
- Chroma Accuracy: 0.1230
- Pitch Contour Similarity: 0.5525
- Overall: 0.3467

---

### Hedwig's theme x dizi (Harry Potter)

**Generated File:** `Hedwig's theme x dizi_60s_generated.wav`

**Text Input (Qwen2-Audio Natural Language Caption):**

The melody is bouncy and light, making it feel energetic. It has a moderate tempo with a steady beat, creating an uplifting yet calm atmosphere. The harmony follows a descending pattern which contributes to a slightly melancholic feeling. Overall, the music exudes warmth and positivity.

**CLAP Similarity:**
- Target ↔ Text: 0.3098
- Text ↔ Generated: 0.3358
- Generated ↔ Target: 0.4692

**Meta Audiobox Aesthetics:**
- Target: CE=1.000, CU=1.000, PC=1.000, PQ=1.000
- Generated: CE=1.000, CU=0.698, PC=1.000, PQ=1.000

**Melody Accuracy:**
- Chroma Similarity: 0.2391
- Chroma Accuracy: 0.0882
- Pitch Contour Similarity: 0.4751
- Overall: 0.2495

---

### 竹笛｜这世界那么多人 (Cover)

**Generated File:** `竹笛｜这世界那么多人_cover_60s_generated.wav`

**Text Input (Qwen2-Audio Natural Language Caption):**

The melody in this music piece flows smoothly, creating a gentle and calming sound. It's not too fast or too slow, providing a steady and soothing rhythm that invites relaxation. The harmony is丰富 yet balanced, contributing to an overall warm and inviting atmosphere. The energy level is low, making it suitable for moments of introspection or relaxation.

**CLAP Similarity:**
- Target ↔ Text: 0.5833
- Text ↔ Generated: 0.4281
- Generated ↔ Target: 0.5240

**Meta Audiobox Aesthetics:**
- Target: CE=1.000, CU=0.938, PC=1.000, PQ=1.000
- Generated: CE=1.000, CU=1.000, PC=1.000, PQ=1.000

**Melody Accuracy:**
- Chroma Similarity: 0.4122
- Chroma Accuracy: 0.1810
- Pitch Contour Similarity: 0.3814
- Overall: 0.3105

---

### Spirited Away OST (Piano)

**Generated File:** `Spirited Away OST_60s_generated.wav`

**Text Input (Qwen2-Audio Natural Language Caption):**

The melody of the piece flows smoothly, creating a gentle and calming sound. It's not too fast or too slow, providing a steady and relaxed pace throughout. The harmony is relatively major, contributing to an uplifting and positive atmosphere. The rhythm and beat remain consistent, maintaining a steady tempo that supports the smooth flow of the melody. Overall, the piece has a light and lively energy level, making it enjoyable and engaging to listen to.

**CLAP Similarity:**
- Target ↔ Text: 0.4485
- Text ↔ Generated: 0.2213
- Generated ↔ Target: 0.2958

**Meta Audiobox Aesthetics:**
- Target: CE=1.000, CU=0.692, PC=1.000, PQ=1.000
- Generated: CE=1.000, CU=1.000, PC=1.000, PQ=1.000

**Melody Accuracy:**
- Chroma Similarity: 0.3626
- Chroma Accuracy: 0.2065
- Pitch Contour Similarity: 0.5296
- Overall: 0.3503

---

### Mussorgsky: Pictures at an Exhibition (Piano)

**Generated File:** `Mussorgsky_60s_generated.wav`

**Text Input (Qwen2-Audio Natural Language Caption):**

The melody feels light and bouncy, moving smoothly from note to note without any sharp jolts. It has a moderate tempo, neither too fast nor too slow, creating an easy-going atmosphere. The harmony follows a typical classical pattern, moving through a sequence of major and minor chords that contribute to a slightly somber but still pleasant mood. Overall, the music has a relaxed and uplifting energy level.

**CLAP Similarity:**
- Target ↔ Text: 0.3392
- Text ↔ Generated: 0.5476
- Generated ↔ Target: 0.3595

**Meta Audiobox Aesthetics:**
- Target: CE=1.000, CU=0.689, PC=1.000, PQ=1.000
- Generated: CE=1.000, CU=1.000, PC=1.000, PQ=1.000

**Melody Accuracy:**
- Chroma Similarity: 0.3217
- Chroma Accuracy: 0.0789
- Pitch Contour Similarity: 0.6663
- Overall: 0.3280

---

### IRIS OUT (Piano)

**Generated File:** `IRIS OUT_generated.wav`

**Text Input (Qwen2-Audio Natural Language Caption):**

The melody feels light and bouncy, with a sense of joy and ease. It's not too fast or too slow but moves at a comfortable pace. The harmony isn't complex but has a pleasant major key that contributes to an uplifting atmosphere. The rhythm maintains a steady tempo, giving the music a sense of stability and flow. Overall, it's a lively and energetic track that leaves you feeling uplifted and positive.

**CLAP Similarity:**
- Target ↔ Text: 0.2357
- Text ↔ Generated: 0.3958
- Generated ↔ Target: 0.2313

**Meta Audiobox Aesthetics:**
- Target: CE=1.000, CU=1.000, PC=1.000, PQ=1.000
- Generated: CE=1.000, CU=1.000, PC=1.000, PQ=1.000

**Melody Accuracy:**
- Chroma Similarity: 0.3891
- Chroma Accuracy: 0.0928
- Pitch Contour Similarity: 0.3852
- Overall: 0.2694

---

## CFG Experiments

### JASCO Configuration Results

| Configuration | γ_all | γ_txt | Gen↔Target | Text↔Gen | Melody Acc | Aesthetics CE |
|--------------|-------|-------|------------|----------|------------|---------------|
| melody_heavy | 7.0 | 0.5 | 0.3255 | 0.2844 | 0.3256 | 0.915 |
| melody_focused | 5.0 | 1.0 | 0.3468 | 0.3094 | 0.3305 | 0.944 |
| balanced | 4.0 | 2.0 | 0.3545 | 0.3192 | 0.3311 | 0.957 |
| **text_focused** | **3.0** | **3.0** | **0.3800** | **0.3339** | **0.3318** | **0.957** |
| text_heavy | 2.0 | 4.0 | 0.3563 | 0.3346 | 0.3287 | 0.951 |

### MusicGen-Melody Configuration Results

| Configuration | Guidance Scale | Gen↔Target | Text↔Gen | Melody Acc | Aesthetics CE |
|--------------|----------------|------------|----------|------------|---------------|
| low_guidance | 2.0 | 0.1930 | 0.3255 | 0.2951 | 0.845 |
| medium_guidance | 3.0 | 0.2029 | 0.3307 | 0.2969 | 0.870 |
| high_guidance | 5.0 | 0.2128 | 0.3392 | 0.3015 | 0.900 |
| very_high_guidance | 7.0 | 0.2156 | 0.3428 | 0.3047 | 0.915 |

### Model Comparison

| Model | Best Config | Gen↔Target | Text↔Gen | Melody Acc | Aesthetics CE |
|-------|-------------|------------|----------|------------|---------------|
| **JASCO** | text_focused (3.0/3.0) | **0.4292** | 0.3035 | **0.3346** | **0.978** |
| MusicGen-Melody | very_high (7.0) | 0.2156 | **0.3428** | 0.3047 | 0.915 |

---

## Analysis

**CFG Trade-off:** Equal weighting (3.0/3.0) achieves the best balance, heavy melody guidance (7.0/0.5) degrades target matching while heavy text guidance (2.0/4.0) maintains reasonable performance.

**JASCO vs MusicGen-Melody:** JASCO outperforms MusicGen-Melody by 100% on Gen↔Target (0.43 vs 0.21), demonstrating that separate CFG controls for melody/chords/drums provide superior controllability over single guidance scale.

**LP-MusicCaps vs Qwen2-Audio:** Qwen2-Audio generates natural, controllable descriptions focusing on melodic character and rhythm, while LP-MusicCaps produces segment-based technical descriptions with repetitive patterns unsuitable for text-to-music models.

---

## Thoughts and Discussion

This project demonstrates the importance of multi-modal conditioning in controllable music generation. Key findings include:

1. **Balanced CFG is Critical:** Equal weighting between text and melodic conditions (γ_all=3.0, γ_txt=3.0) significantly outperforms heavy melody guidance, suggesting that over-emphasizing structural conditions can degrade overall quality.

2. **Caption Quality Matters:** Qwen2-Audio's natural language descriptions focusing on controllable musical characteristics (melodic character, rhythm, harmony) prove far more effective than LP-MusicCaps' technical segment-based descriptions for text-to-music generation.

3. **Separate Controls Win:** JASCO's architecture with independent CFG controls for melody, chords, and drums achieves 100% better target matching compared to MusicGen-Melody's single guidance scale, highlighting the value of fine-grained controllability.

4. **Melody Extraction Trade-offs:** Using basic_pitch with threshold 0.3 creates sparse representations (~18 non-zero elements) that work better for generation than dense representations, balancing information content with model capacity.

Future work could explore dynamic CFG scheduling, multi-stage generation with progressive refinement, and integration of additional modalities like tempo curves and dynamic contours.
